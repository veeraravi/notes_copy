import org.scalatest.funsuite.AnyFunSuite
import org.mockito.Mockito._
import org.mockito.ArgumentMatchers._
import org.slf4j.LoggerFactory
import org.mockito.Mockito.RETURNS_DEEP_STUBS

class CopyFromHdfsToNasTest extends AnyFunSuite {

  val logger = LoggerFactory.getLogger(this.getClass)

  test("copyFromHdfsToNas should return true when retryCopy succeeds") {
    // Mock dependencies
    val mockRetryCopy = mock[Function2[String, String, Boolean]]
    val mockEnsureLocalPathExists = mock[Function1[String, Unit]]

    // Mocking HDFS and Local destination paths
    val mockHdfsSourcePath = mock[String]
    val mockLocalDestPath = mock[String]

    // Stubbing behavior
    when(mockRetryCopy.apply(any[String], any[String])).thenReturn(true)

    // Call the function under test
    val result = {
      val ensureLocalPathExists = mockEnsureLocalPathExists.apply(mockLocalDestPath)
      val success = mockRetryCopy.apply(mockHdfsSourcePath, mockLocalDestPath)
      if (success) {
        logger.info(s"Files copied successfully from $mockHdfsSourcePath to $mockLocalDestPath")
      } else {
        logger.error(s"Failed to copy files from $mockHdfsSourcePath to $mockLocalDestPath after maxRetries retries.")
        throw new RuntimeException(s"Failed to copy files from: $mockHdfsSourcePath to $mockLocalDestPath after maxRetries retries")
      }
      success
    }

    // Assert the expected outcome
    assert(result)
    verify(mockRetryCopy).apply(mockHdfsSourcePath, mockLocalDestPath)
  }

  test("copyFromHdfsToNas should throw RuntimeException when retryCopy fails") {
    // Mock dependencies
    val mockRetryCopy = mock[Function2[String, String, Boolean]]
    val mockEnsureLocalPathExists = mock[Function1[String, Unit]]

    // Mocking HDFS and Local destination paths
    val mockHdfsSourcePath = mock[String]
    val mockLocalDestPath = mock[String]

    // Stubbing behavior
    when(mockRetryCopy.apply(any[String], any[String])).thenReturn(false)

    // Verify that the exception is thrown
    val exception = intercept[RuntimeException] {
      val ensureLocalPathExists = mockEnsureLocalPathExists.apply(mockLocalDestPath)
      val success = mockRetryCopy.apply(mockHdfsSourcePath, mockLocalDestPath)
      if (success) {
        logger.info(s"Files copied successfully from $mockHdfsSourcePath to $mockLocalDestPath")
      } else {
        logger.error(s"Failed to copy files from $mockHdfsSourcePath to $mockLocalDestPath after maxRetries retries.")
        throw new RuntimeException(s"Failed to copy files from: $mockHdfsSourcePath to $mockLocalDestPath after maxRetries retries")
      }
      success
    }

    assert(exception.getMessage.contains("Failed to copy files"))
    verify(mockRetryCopy).apply(mockHdfsSourcePath, mockLocalDestPath)
  }
}
